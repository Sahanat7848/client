<div class="mission-manager-container">
    <div class="dashboard-header">
        <div class="header-content">
            <h1 class="page-title">Operations Command</h1>
            <p class="page-subtitle">Manage and monitor your ongoing expeditionary missions</p>
        </div>
        <div class="header-actions">
            <button mat-raised-button color="primary" (click)="openDialog()" class="spawn-mission-btn">
                <mat-icon>add_circle</mat-icon>
                <span>Initiate Mission</span>
            </button>
        </div>
    </div>

    <!-- Stats Section -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon open">
                <mat-icon>explore</mat-icon>
            </div>
            <div class="stat-info">
                <span class="stat-label">Active Missions</span>
                <span class="stat-value">{{resultsLength}}</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon crew">
                <mat-icon>groups</mat-icon>
            </div>
            <div class="stat-info">
                <span class="stat-label">Total Recon Crew</span>
                <span class="stat-value">{{totalCrew}}</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon status">
                <mat-icon>verified</mat-icon>
            </div>
            <div class="stat-info">
                <span class="stat-label">Success Rate</span>
                <span class="stat-value">{{successRate}}%</span>
            </div>
        </div>
    </div>

    <div class="table-container mat-elevation-z8">
        <div class="table-header">
            <h3>Mission Manifest</h3>
            <span class="spacer"></span>
            <!-- Add search/filter here if needed later -->
        </div>

        @if (isLoadingResults || isRateLimitReached) {
        <div class="loading-shade">
            @if (isLoadingResults) {
            <mat-spinner diameter="40"></mat-spinner>
            }
            @if (isRateLimitReached) {
            <div class="rate-limit-msg">
                <mat-icon>warning</mat-icon>
                <span>Nexus connection throttled. Retrying...</span>
            </div>
            }
        </div>
        }

        <div class="table-viewport">
            <table mat-table [dataSource]="dataSource" matSort matSortActive="created_at" matSortDisableClear
                matSortDirection="desc">

                <!-- Name Column -->
                <ng-container matColumnDef="name">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Designation</th>
                    <td mat-cell *matCellDef="let row" class="mission-name-cell">
                        <mat-icon class="mission-type-icon">military_tech</mat-icon>
                        <span>{{row.name}}</span>
                    </td>
                </ng-container>

                <!-- Description Column -->
                <ng-container matColumnDef="description">
                    <th mat-header-cell *matHeaderCellDef>Operational Objective</th>
                    <td mat-cell *matCellDef="let row" class="description-cell">{{row.description}}</td>
                </ng-container>

                <!-- Status Column -->
                <ng-container matColumnDef="status">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
                    <td mat-cell *matCellDef="let row">
                        <span class="status-pill" [ngClass]="row.status">{{row.status}}</span>
                    </td>
                </ng-container>

                <!-- Crew Count Column -->
                <ng-container matColumnDef="crew_count">
                    <th mat-header-cell *matHeaderCellDef>Crew</th>
                    <td mat-cell *matCellDef="let row">
                        <div class="crew-badge">
                            <mat-icon>account_circle</mat-icon>
                            <span>{{row.crew_count}}</span>
                        </div>
                    </td>
                </ng-container>

                <!-- Created Column -->
                <ng-container matColumnDef="created_at">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header disableClear>Deployed</th>
                    <td mat-cell *matCellDef="let row">{{row.created_at | date:'MMM d, HH:mm'}}</td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="mission-row"></tr>

                <!-- Row shown when there is no data. -->
                <tr class="mat-row" *matNoDataRow>
                    <td class="mat-cell" [attr.colspan]="displayedColumns.length"
                        style="text-align: center; padding: 3rem; color: #6b7280;">
                        <mat-icon
                            style="font-size: 48px; width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.3;">
                            inbox
                        </mat-icon>
                        <p style="margin: 0; font-weight: 500;">No operational missions detected in the manifest.</p>
                        <small>Initiate a new mission to begin deployment.</small>
                    </td>
                </tr>
            </table>
        </div>

        <mat-paginator [length]="resultsLength" [pageSize]="10" [pageSizeOptions]="[5, 10, 25, 100]"
            aria-label="Select page of missions"></mat-paginator>
    </div>
</div>